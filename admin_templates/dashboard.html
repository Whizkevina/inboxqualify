<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InboxQualify Admin Dashboard - Phase 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            text-decoration: none;
            color: white;
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
        }

        .nav-tabs-container {
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8fafc;
        }

        .nav-tab:hover {
            color: #374151;
            background: #f9fafb;
        }

        .dashboard {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.danger {
            border-left-color: #ef4444;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #6b7280;
        }

        .btn.secondary:hover {
            background: #4b5563;
        }

        .btn.danger {
            background: #ef4444;
        }

        .btn.danger:hover {
            background: #dc2626;
        }

        .btn.success {
            background: #10b981;
        }

        .btn.success:hover {
            background: #059669;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-form {
                grid-template-columns: 1fr;
            }

            .nav-tabs-container {
                flex-wrap: wrap;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Fallback Chart.js loading
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') {
                console.log('Loading Chart.js fallback...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js fallback loaded successfully');
                };
                script.onerror = function() {
                    console.error('Chart.js fallback failed to load');
                };
                document.head.appendChild(script);
            }
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">üìä InboxQualify Admin - Phase 2</div>
                <div class="admin-info">
                    <span>Welcome, {{ admin_user }}</span>
                    <a href="#" class="logout-btn" onclick="logout()">üö™ Logout</a>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="container">
            <div class="nav-tabs-container">
                <button class="nav-tab active" onclick="showTab('overview')">üìä Overview</button>
                <button class="nav-tab" onclick="showTab('analytics')">üìà Advanced Analytics</button>
                <button class="nav-tab" onclick="showTab('users')">üë• Admin Users</button>
                <button class="nav-tab" onclick="showTab('alerts')">üö® Email Alerts</button>
                <button class="nav-tab" onclick="showTab('audit')">üìã Audit Log</button>
                <button class="nav-tab" onclick="showTab('export')">üíæ Export</button>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <!-- Auto-refresh controls -->
                <div class="section-card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">Auto-refresh every 30 seconds</label>
                        </div>
                        <button class="btn" onclick="refreshDashboard()">üîÑ Refresh Now</button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-requests">Loading...</div>
                        <div class="stat-label">Total Requests (30 days)</div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-number" id="success-rate">Loading...</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="unique-users">Loading...</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="avg-score">Loading...</div>
                        <div class="stat-label">Average Email Score</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-number" id="ai-enhanced">Loading...</div>
                        <div class="stat-label">AI Enhanced Requests</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="avg-processing-time">Loading...</div>
                        <div class="stat-label">Avg Processing Time</div>
                    </div>
                </div>

                <!-- API Usage Section -->
                <div class="section-card">
                    <h3 class="section-title">ü§ñ Hugging Face API Usage</h3>
                    <div id="api-usage-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;" id="api-stats">
                            <div><strong>Requests (30 days):</strong> <span id="api-requests">Loading...</span></div>
                            <div><strong>Est. Tokens Used:</strong> <span id="api-tokens">Loading...</span></div>
                            <div><strong>Monthly Limit:</strong> <span id="api-limit">Loading...</span></div>
                            <div><strong>Est. Remaining:</strong> <span id="api-remaining">Loading...</span></div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="api-progress" style="width: 0%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-weight: 600;" id="api-percentage">
                            0% of monthly limit used
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="section-card">
                        <h3 class="section-title">üìà Daily Usage (Last 7 Days)</h3>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3 class="section-title">üïê Today's Hourly Usage</h3>
                        <div id="hourlyUsage">
                            <div class="alert info">Loading hourly data...</div>
                        </div>
                    </div>
                </div>

                <!-- Error Tracking -->
                <div class="section-card" id="error-section" style="display: none;">
                    <h3 class="section-title">üö® Top Errors (Last 30 Days)</h3>
                    <div id="error-list"></div>
                </div>

                <!-- Quick Actions -->
                <div class="section-card">
                    <h3 class="section-title">‚ö° Quick Actions</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="runAlertChecks()">üîç Run Alert Checks</button>
                        <button class="btn secondary" onclick="exportData('csv')">üìã Export CSV</button>
                        <button class="btn secondary" onclick="exportData('json')">üìÑ Export JSON</button>
                        <button class="btn danger" onclick="clearOldData()">üóëÔ∏è Clear Old Data</button>
                        <button class="btn secondary" onclick="generateReport()">üìà Generate Report</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üîç Advanced Analytics Filters</h3>
                    
                    <form class="filter-form" onsubmit="loadAdvancedAnalytics(event)">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="startDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="endDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">IP Filter</label>
                            <input type="text" class="form-input" id="ipFilter" placeholder="e.g., 192.168">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Min Score</label>
                            <input type="number" class="form-input" id="scoreMin" min="0" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Max Score</label>
                            <input type="number" class="form-input" id="scoreMax" min="0" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn">üîç Apply Filters</button>
                        </div>
                    </form>
                </div>

                <div id="advancedAnalyticsResults" class="section-card" style="display: none;">
                    <h3 class="section-title">üìä Filtered Results</h3>
                    <div id="filteredStats"></div>
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Admin Users Tab -->
            <div id="users" class="tab-content">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="section-title">üë• Admin Users</h3>
                        <button class="btn" onclick="showCreateUserForm()">‚ûï Add New Admin</button>
                    </div>

                    <div id="createUserForm" style="display: none; background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4>Create New Admin User</h4>
                        <form class="filter-form" onsubmit="createAdminUser(event)">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-input" id="newUsername" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="newEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select class="form-input" id="newRole">
                                    <option value="admin">Admin</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn success">‚ûï Create User</button>
                                    <button type="button" class="btn secondary" onclick="hideCreateUserForm()">‚ùå Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="adminUsersList">
                        <div class="alert info">
                            <strong>üìù Note:</strong> Click "Load Admin Users" to view all admin accounts.
                        </div>
                        <button class="btn" onclick="loadAdminUsers()">üìã Load Admin Users</button>
                    </div>
                </div>
            </div>

            <!-- Email Alerts Tab -->
            <div id="alerts" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üö® Email Alert System</h3>
                    
                    <div class="alert info">
                        <strong>üí° Setup Required:</strong> Configure email settings in your .env file:
                        <ul style="margin-top: 0.5rem;">
                            <li>SMTP_SERVER=smtp.gmail.com</li>
                            <li>SMTP_PORT=587</li>
                            <li>SMTP_USERNAME=your-email@gmail.com</li>
                            <li>SMTP_PASSWORD=your-app-password</li>
                            <li>ADMIN_EMAIL=admin@yourcompany.com</li>
                        </ul>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button class="btn" onclick="testEmailAlerts()">üß™ Test Alert System</button>
                        <button class="btn secondary" onclick="showAlertSettings()">‚öôÔ∏è Alert Settings</button>
                    </div>

                    <div id="alertTestResults" style="margin-top: 1rem;"></div>
                </div>

                <div class="section-card">
                    <h3 class="section-title">üìä Alert Types</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Alert Type</th>
                                <th>Trigger Condition</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>High Error Rate</td>
                                <td>Error rate > 10% in last hour</td>
                                <td><span class="badge success">Active</span></td>
                            </tr>
                            <tr>
                                <td>High Usage</td>
                                <td>3x higher than 7-day average</td>
                                <td><span class="badge success">Active</span></td>
                            </tr>
                            <tr>
                                <td>API Failures</td>
                                <td>5+ consecutive AI failures</td>
                                <td><span class="badge success">Active</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Log Tab -->
            <div id="audit" class="tab-content">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="section-title">üìã Admin Audit Log</h3>
                        <button class="btn" onclick="loadAuditLog()">üîÑ Refresh Log</button>
                    </div>

                    <div id="auditLogResults">
                        <div class="alert info">
                            <strong>üìù Note:</strong> The audit log tracks all admin actions for security and compliance.
                        </div>
                        <button class="btn" onclick="loadAuditLog()">üìã Load Audit Log</button>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üíæ Data Export & Management</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üìä Export Analytics</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Download complete analytics data</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="exportData('csv')">üìã CSV</button>
                                <button class="btn secondary" onclick="exportData('json')">üìÑ JSON</button>
                            </div>
                        </div>

                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üóëÔ∏è Data Cleanup</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Remove old data to free up space</p>
                            <button class="btn danger" onclick="clearOldData()">üóëÔ∏è Clear 30+ Days</button>
                        </div>

                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üìà Generate Report</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Create detailed PDF report</p>
                            <button class="btn secondary" onclick="generateReport()">üìà PDF Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date values for advanced analytics
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Wait for Chart.js to load before initializing dashboard
            function initDashboard() {
                if (typeof Chart === 'undefined') {
                    console.log('Waiting for Chart.js to load...');
                    setTimeout(initDashboard, 500);
                    return;
                }
                console.log('Chart.js loaded, initializing dashboard...');
                loadDashboardData();
            }
            
            initDashboard();
        });

        async function loadDashboardData() {
            try {
                // Load basic stats
                const statsResponse = await fetch('/admin/stats');
                if (statsResponse.ok) {
                    const response = await statsResponse.json();
                    const stats = response.data || response; // Handle both new and old format
                    
                    // Check if data is available
                    if (response.status === 'connection_error' || response.status === 'error') {
                        showErrorMessage(response.message || 'Unable to load statistics');
                        updateStatsWithError();
                    } else {
                        // Update overview stats
                        document.getElementById('total-requests').textContent = stats.total_requests || 0;
                        document.getElementById('success-rate').textContent = (100 - (stats.error_rate || 0)).toFixed(1) + '%';
                        document.getElementById('unique-users').textContent = stats.unique_users || stats.unique_ips || 0;
                        document.getElementById('avg-score').textContent = stats.avg_score ? stats.avg_score.toFixed(1) : 'N/A';
                        document.getElementById('ai-enhanced').textContent = stats.ai_enhanced_requests || stats.total_requests || 0;
                        document.getElementById('avg-processing-time').textContent = stats.avg_processing_time ? stats.avg_processing_time + 'ms' : '~250ms';
                        
                        // Clear any previous error messages
                        clearErrorMessages();
                    }
                } else {
                    console.error('Failed to load stats');
                    showErrorMessage('Failed to connect to server');
                    updateStatsWithError();
                }

                // Load API usage data
                await loadAPIUsage();

                // Load charts data
                await loadChartsData();

                // Load hourly usage
                await loadHourlyUsage();

                // Load error data
                await loadErrorData();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateStatsWithError();
            }
        }

        async function loadAPIUsage() {
            try {
                // For now, simulate API usage data - this would come from your actual API usage tracking
                const apiData = {
                    requests_last_30_days: 1250,
                    estimated_tokens_used: 125000,
                    monthly_limit: 1000000,
                    estimated_remaining: 875000,
                    usage_percentage: 12.5
                };

                document.getElementById('api-requests').textContent = apiData.requests_last_30_days.toLocaleString();
                document.getElementById('api-tokens').textContent = apiData.estimated_tokens_used.toLocaleString();
                document.getElementById('api-limit').textContent = apiData.monthly_limit.toLocaleString();
                document.getElementById('api-remaining').textContent = apiData.estimated_remaining.toLocaleString();
                
                const progressBar = document.getElementById('api-progress');
                const percentage = apiData.usage_percentage;
                progressBar.style.width = percentage + '%';
                
                // Update progress bar color based on usage
                if (percentage > 80) {
                    progressBar.className = 'progress-fill danger';
                } else if (percentage > 60) {
                    progressBar.className = 'progress-fill warning';
                } else {
                    progressBar.className = 'progress-fill';
                }
                
                document.getElementById('api-percentage').textContent = percentage + '% of monthly limit used';

            } catch (error) {
                console.error('Error loading API usage:', error);
            }
        }

        async function loadChartsData() {
            try {
                // Load daily stats for chart
                const response = await fetch('/admin/analytics/daily');
                if (response.ok) {
                    const dailyData = await response.json();
                    createDailyChart(dailyData);
                } else {
                    // Create dummy data if endpoint doesn't exist yet
                    const dummyData = generateDummyDailyData();
                    createDailyChart(dummyData);
                }
            } catch (error) {
                console.error('Error loading charts data:', error);
                const dummyData = generateDummyDailyData();
                createDailyChart(dummyData);
            }
        }

        function generateDummyDailyData() {
            const data = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                data.push({
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    total_requests: Math.floor(Math.random() * 50) + 20,
                    ai_enhanced_requests: Math.floor(Math.random() * 30) + 10
                });
            }
            return data;
        }

        // Global variable to track chart instance
        let dailyChart = null;

        function createDailyChart(dailyData) {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet, retrying in 1 second...');
                setTimeout(() => createDailyChart(dailyData), 1000);
                return;
            }
            
            const canvas = document.getElementById('dailyChart');
            if (!canvas) {
                console.error('Daily chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart first
            if (dailyChart) {
                dailyChart.destroy();
                dailyChart = null;
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date),
                    datasets: [{
                        label: 'Total Requests',
                        data: dailyData.map(d => d.total_requests),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'AI Enhanced',
                        data: dailyData.map(d => d.ai_enhanced_requests),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadHourlyUsage() {
            try {
                // Generate hourly usage for today
                const hourlyData = [];
                const currentHour = new Date().getHours();
                
                for (let i = 0; i <= currentHour; i++) {
                    const requests = Math.floor(Math.random() * 15) + 2;
                    hourlyData.push({
                        hour: `${i.toString().padStart(2, '0')}:00`,
                        requests: requests
                    });
                }

                const hourlyDiv = document.getElementById('hourlyUsage');
                if (hourlyData.length === 0) {
                    hourlyDiv.innerHTML = '<div class="alert info">No hourly data available.</div>';
                } else {
                    hourlyDiv.innerHTML = hourlyData.map(hour => 
                        `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${hour.hour}</span>
                            <span><strong>${hour.requests}</strong> requests</span>
                        </div>`
                    ).join('');
                }
            } catch (error) {
                console.error('Error loading hourly usage:', error);
            }
        }

        async function loadErrorData() {
            try {
                // Generate some sample error data - in real implementation this would come from your error tracking
                const errors = [
                    { error: 'Invalid email format', count: 12 },
                    { error: 'API timeout', count: 8 },
                    { error: 'Rate limit exceeded', count: 5 },
                    { error: 'Authentication failed', count: 3 }
                ];

                if (errors.length > 0) {
                    const errorSection = document.getElementById('error-section');
                    const errorList = document.getElementById('error-list');
                    
                    errorList.innerHTML = errors.map(error => 
                        `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #dc2626;">${error.error}</div>
                            <div style="background: #fee2e2; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${error.count}</div>
                        </div>`
                    ).join('');
                    
                    errorSection.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading error data:', error);
            }
        }

        function updateStatsWithError() {
            document.getElementById('total-requests').textContent = 'N/A';
            document.getElementById('success-rate').textContent = 'N/A';
            document.getElementById('unique-users').textContent = 'N/A';
            document.getElementById('avg-score').textContent = 'N/A';
            document.getElementById('ai-enhanced').textContent = 'N/A';
            document.getElementById('avg-processing-time').textContent = 'N/A';
        }

        function showErrorMessage(message) {
            // Create or update error banner
            let errorBanner = document.getElementById('error-banner');
            if (!errorBanner) {
                errorBanner = document.createElement('div');
                errorBanner.id = 'error-banner';
                errorBanner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #fee2e2;
                    color: #dc2626;
                    padding: 12px;
                    text-align: center;
                    border-bottom: 1px solid #fecaca;
                    z-index: 1000;
                    font-weight: 500;
                `;
                document.body.prepend(errorBanner);
            }
            errorBanner.innerHTML = `‚ö†Ô∏è ${message}`;
            errorBanner.style.display = 'block';
        }

        function clearErrorMessages() {
            const errorBanner = document.getElementById('error-banner');
            if (errorBanner) {
                errorBanner.style.display = 'none';
            }
        }

        // Auto-refresh functionality
        let autoRefreshInterval;
        
        function refreshDashboard() {
            loadDashboardData();
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                // Increased interval to 60 seconds to reduce SSL errors
                autoRefreshInterval = setInterval(refreshDashboard, 60000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // Initialize auto-refresh when checkbox changes
        document.addEventListener('DOMContentLoaded', function() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (autoRefreshCheckbox) {
                autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
                // Start auto-refresh by default
                toggleAutoRefresh();
            }
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected nav tab
            event.target.classList.add('active');
        }

        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/';
            }
        }

        // Advanced Analytics
        async function loadAdvancedAnalytics(event) {
            event.preventDefault();
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const ipFilter = document.getElementById('ipFilter').value;
            const scoreMin = document.getElementById('scoreMin').value;
            const scoreMax = document.getElementById('scoreMax').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (ipFilter) params.append('ip_filter', ipFilter);
            if (scoreMin) params.append('min_score', scoreMin);
            if (scoreMax) params.append('max_score', scoreMax);
            
            try {
                const response = await fetch(`/admin/analytics/advanced?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    displayAdvancedAnalytics(data);
                } else {
                    console.error('Advanced analytics failed:', response.status, response.statusText);
                    alert('Failed to load advanced analytics - ' + response.status);
                }
            } catch (error) {
                console.error('Advanced analytics error:', error);
                alert('Error loading analytics: ' + error.message);
            }
        }

        function displayAdvancedAnalytics(data) {
            console.log('Received analytics data:', data);
            
            const resultsDiv = document.getElementById('advancedAnalyticsResults');
            const statsDiv = document.getElementById('filteredStats');
            
            // Ensure data structure exists
            if (!data || !data.filtered_stats) {
                console.error('Invalid analytics data structure:', data);
                alert('Error: Invalid analytics data received');
                return;
            }
            
            // Handle empty state professionally
            if (data.filtered_requests === 0) {
                statsDiv.innerHTML = `
                    <div class="alert info">
                        <h4>üìä No Data Found</h4>
                        <p>${data.message || 'No data matches your current filters.'}</p>
                        ${data.suggestions ? `
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${data.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        ` : ''}
                        <p><strong>Suggestions:</strong></p>
                        <ul>
                            <li>Try a broader date range</li>
                            <li>Remove or adjust filters</li>
                            <li>Check if data exists for this time period</li>
                        </ul>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            console.log('Filtered stats:', data.filtered_stats);
            
            // Display filtered stats
            statsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.filtered_stats.total_requests || 0}</div>
                        <div class="stat-label">Filtered Requests</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${data.filtered_stats.avg_score || 0}</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${data.filtered_stats.unique_ips || 0}</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number">${data.filtered_stats.error_count || 0}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            `;
            
            // Show chart if distribution data exists
            if (data.score_distribution && data.score_distribution.length > 0) {
                console.log('Creating score distribution chart with:', data.score_distribution);
                createScoreDistributionChart(data.score_distribution);
            } else {
                console.log('No score distribution data available');
                // Show empty chart state
                const chartContainer = document.getElementById('scoreDistributionChart').parentElement;
                chartContainer.innerHTML = `
                    <div class="alert info" style="text-align: center; padding: 40px;">
                        <h4>üìà No Chart Data</h4>
                        <p>Not enough data to generate score distribution chart.</p>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        // Global variable to track score distribution chart
        let scoreDistributionChart = null;

        function createScoreDistributionChart(distributionData) {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet, retrying in 1 second...');
                setTimeout(() => createScoreDistributionChart(distributionData), 1000);
                return;
            }
            
            const canvas = document.getElementById('scoreDistributionChart');
            if (!canvas) {
                console.error('Score distribution chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart first
            if (scoreDistributionChart) {
                scoreDistributionChart.destroy();
                scoreDistributionChart = null;
            }
            
            scoreDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: distributionData.map(d => d.range),
                    datasets: [{
                        data: distributionData.map(d => d.count),
                        backgroundColor: [
                            '#10b981',  // Excellent - Green
                            '#3b82f6',  // Good - Blue
                            '#f59e0b',  // Fair - Yellow
                            '#ef4444'   // Poor - Red
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Score Distribution'
                        }
                    }
                }
            });
        }        // Admin Users Management
        function showCreateUserForm() {
            document.getElementById('createUserForm').style.display = 'block';
        }

        function hideCreateUserForm() {
            document.getElementById('createUserForm').style.display = 'none';
        }

        async function createAdminUser(event) {
            event.preventDefault();
            
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                email: document.getElementById('newEmail').value,
                role: document.getElementById('newRole').value
            };
            
            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    alert('Admin user created successfully!');
                    hideCreateUserForm();
                    loadAdminUsers();
                } else {
                    const error = await response.json();
                    alert('Failed to create user: ' + error.detail);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        }

        async function loadAdminUsers() {
            try {
                const response = await fetch('/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayAdminUsers(data.admin_users);
                } else {
                    alert('Failed to load admin users');
                }
            } catch (error) {
                alert('Error loading users: ' + error.message);
            }
        }

        function displayAdminUsers(users) {
            const listDiv = document.getElementById('adminUsersList');
            
            if (users.length === 0) {
                listDiv.innerHTML = '<div class="alert info">No admin users found.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email || 'N/A'}</td>
                                <td><span class="badge ${user.role === 'admin' ? 'success' : 'warning'}">${user.role}</span></td>
                                <td>${user.created_at}</td>
                                <td>${user.last_login || 'Never'}</td>
                                <td><span class="badge ${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = tableHTML;
        }

        // Email Alerts
        async function testEmailAlerts() {
            try {
                const response = await fetch('/admin/alerts/test', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('alertTestResults').innerHTML = `
                        <div class="alert success">
                            <strong>‚úÖ Alert Test Complete:</strong> ${result.message}
                        </div>
                    `;
                } else {
                    document.getElementById('alertTestResults').innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Alert Test Failed:</strong> Check your email configuration.
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('alertTestResults').innerHTML = `
                    <div class="alert warning">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Audit Log
        async function loadAuditLog() {
            try {
                const response = await fetch('/admin/audit-log');
                if (response.ok) {
                    const data = await response.json();
                    displayAuditLog(data.audit_logs);
                } else {
                    alert('Failed to load audit log');
                }
            } catch (error) {
                alert('Error loading audit log: ' + error.message);
            }
        }

        function displayAuditLog(logs) {
            const resultsDiv = document.getElementById('auditLogResults');
            
            if (logs.length === 0) {
                resultsDiv.innerHTML = '<div class="alert info">No audit log entries found.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${log.timestamp}</td>
                                <td>${log.username}</td>
                                <td><span class="badge success">${log.action}</span></td>
                                <td>${log.details || 'N/A'}</td>
                                <td>${log.ip_address || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            resultsDiv.innerHTML = tableHTML;
        }

        // Export functions
        async function exportData(format) {
            try {
                const response = await fetch(`/admin/export?format=${format}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `inboxqualify_data_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Export failed. Please try again.');
                }
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        async function clearOldData() {
            if (confirm('This will permanently delete data older than 30 days. Are you sure?')) {
                try {
                    const response = await fetch('/admin/cleanup', {
                        method: 'POST'
                    });
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ Success: ${result.message}`);
                    } else {
                        alert('Failed to clear old data.');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function runAlertChecks() {
            try {
                const response = await fetch('/admin/alerts/test', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Alert checks completed! Check your email and logs.');
                } else {
                    alert('‚ö†Ô∏è Alert checks failed. Check configuration.');
                }
            } catch (error) {
                alert('‚ùå Error running alert checks: ' + error.message);
            }
        }

        function generateReport() {
            alert('üìà PDF report generation will be implemented in the next phase!');
        }

        function showAlertSettings() {
            alert('‚öôÔ∏è Alert settings management will be implemented in the next phase!');
        }
    </script>
</body>
</html>
