<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InboxQualify Admin Dashboard - Phase 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            text-decoration: none;
            color: white;
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
        }

        .nav-tabs-container {
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8fafc;
        }

        .nav-tab:hover {
            color: #374151;
            background: #f9fafb;
        }

        .dashboard {
            padding: 2rem 0;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.danger {
            border-left-color: #ef4444;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .section-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }

        .filter-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: #6b7280;
        }

        .btn.secondary:hover {
            background: #4b5563;
        }

        .btn.danger {
            background: #ef4444;
        }

        .btn.danger:hover {
            background: #dc2626;
        }

        .btn.success {
            background: #10b981;
        }

        .btn.success:hover {
            background: #059669;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .chart-container {
            height: 300px;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-form {
                grid-template-columns: 1fr;
            }

            .nav-tabs-container {
                flex-wrap: wrap;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Fallback Chart.js loading
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') {
                console.log('Loading Chart.js fallback...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
                script.onload = function() {
                    console.log('Chart.js fallback loaded successfully');
                };
                script.onerror = function() {
                    console.error('Chart.js fallback failed to load');
                };
                document.head.appendChild(script);
            }
        });
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">üìä InboxQualify Admin - Phase 2</div>
                <div class="admin-info">
                    <span>Welcome, {{ admin_user }}</span>
                    <a href="#" class="logout-btn" onclick="logout()">üö™ Logout</a>
                </div>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <div class="container">
            <div class="nav-tabs-container">
                <button class="nav-tab active" onclick="showTab('overview')">üìä Overview</button>
                <button class="nav-tab" onclick="showTab('analytics')">üìà Advanced Analytics</button>
                <button class="nav-tab" onclick="showTab('users')">üë• Admin Users</button>
                <button class="nav-tab" onclick="showTab('alerts')">üö® Email Alerts</button>
                <button class="nav-tab" onclick="showTab('audit')">üìã Audit Log</button>
                <button class="nav-tab" onclick="showTab('export')">üíæ Export</button>
            </div>
        </div>
    </nav>

    <main class="dashboard">
        <div class="container">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <!-- Auto-refresh controls -->
                <div class="section-card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoRefresh" checked>
                            <label for="autoRefresh">Auto-refresh every 30 seconds</label>
                        </div>
                        <button class="btn" onclick="refreshDashboard()">üîÑ Refresh Now</button>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-requests">Loading...</div>
                        <div class="stat-label">Total Requests (30 days)</div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-number" id="success-rate">Loading...</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="unique-users">Loading...</div>
                        <div class="stat-label">Unique Users</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="avg-score">Loading...</div>
                        <div class="stat-label">Average Email Score</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-number" id="ai-enhanced">Loading...</div>
                        <div class="stat-label">AI Enhanced Requests</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-number" id="avg-processing-time">Loading...</div>
                        <div class="stat-label">Avg Processing Time</div>
                    </div>
                </div>

                <!-- API Usage Section -->
                <div class="section-card">
                    <h3 class="section-title">ü§ñ Hugging Face API Usage</h3>
                    <div id="api-usage-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;" id="api-stats">
                            <div><strong>Requests (30 days):</strong> <span id="api-requests">Loading...</span></div>
                            <div><strong>Est. Tokens Used:</strong> <span id="api-tokens">Loading...</span></div>
                            <div><strong>Monthly Limit:</strong> <span id="api-limit">Loading...</span></div>
                            <div><strong>Est. Remaining:</strong> <span id="api-remaining">Loading...</span></div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="api-progress" style="width: 0%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.5rem; font-weight: 600;" id="api-percentage">
                            0% of monthly limit used
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <div class="section-card">
                        <h3 class="section-title">üìà Daily Usage (Last 7 Days)</h3>
                        <div class="chart-container">
                            <canvas id="dailyChart"></canvas>
                        </div>
                    </div>

                    <div class="section-card">
                        <h3 class="section-title">üïê Today's Hourly Usage</h3>
                        <div id="hourlyUsage">
                            <div class="alert info">Loading hourly data...</div>
                        </div>
                    </div>
                </div>

                <!-- Error Tracking -->
                <div class="section-card" id="error-section" style="display: none;">
                    <h3 class="section-title">üö® Top Errors (Last 30 Days)</h3>
                    <div id="error-list"></div>
                </div>

                <!-- Quick Actions -->
                <div class="section-card">
                    <h3 class="section-title">‚ö° Quick Actions</h3>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn" onclick="runAlertChecks()">üîç Run Alert Checks</button>
                        <button class="btn secondary" onclick="exportData('csv')">üìã Export CSV</button>
                        <button class="btn secondary" onclick="exportData('json')">üìÑ Export JSON</button>
                        <button class="btn danger" onclick="clearOldData()">üóëÔ∏è Clear Old Data</button>
                        <button class="btn secondary" onclick="generateReport()">üìà Generate Report</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üîç Advanced Analytics Filters</h3>
                    
                    <form class="filter-form" onsubmit="loadAdvancedAnalytics(event)">
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-input" id="startDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-input" id="endDate">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">IP Filter</label>
                            <input type="text" class="form-input" id="ipFilter" placeholder="e.g., 192.168">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Min Score</label>
                            <input type="number" class="form-input" id="scoreMin" min="0" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Max Score</label>
                            <input type="number" class="form-input" id="scoreMax" min="0" max="100">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn">üîç Apply Filters</button>
                        </div>
                    </form>
                </div>

                <div id="advancedAnalyticsResults" class="section-card" style="display: none;">
                    <h3 class="section-title">üìä Filtered Results</h3>
                    <div id="filteredStats"></div>
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Admin Users Tab -->
            <div id="users" class="tab-content">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="section-title">üë• Admin Users</h3>
                        <button class="btn" onclick="showCreateUserForm()">‚ûï Add New Admin</button>
                    </div>

                    <div id="createUserForm" style="display: none; background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4>Create New Admin User</h4>
                        <form class="filter-form" onsubmit="createAdminUser(event)">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-input" id="newUsername" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" id="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="newEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select class="form-input" id="newRole">
                                    <option value="admin">Admin</option>
                                    <option value="viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button type="submit" class="btn success">‚ûï Create User</button>
                                    <button type="button" class="btn secondary" onclick="hideCreateUserForm()">‚ùå Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="adminUsersList">
                        <div class="alert info">
                            <strong>üìù Note:</strong> Click "Load Admin Users" to view all admin accounts.
                        </div>
                        <button class="btn" onclick="loadAdminUsers()">üìã Load Admin Users</button>
                    </div>
                </div>
            </div>

            <!-- Email Alerts Tab -->
            <div id="alerts" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üö® Email Alert System</h3>
                    
                    <!-- Email Configuration Status -->
                    <div id="emailStatus" class="alert info">
                        <strong>üìß Checking email configuration...</strong>
                    </div>

                    <div id="emailSetupInstructions" style="display: none;">
                        <div class="alert warning">
                            <strong>üîß Email Setup Required:</strong>
                            <p>To receive email alerts, you need to configure your email settings:</p>
                            <ol style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                <li><strong>Enable 2-Factor Authentication</strong> on your Gmail account</li>
                                <li><strong>Generate an App Password</strong>:
                                    <ul style="margin-top: 0.25rem; padding-left: 1rem;">
                                        <li>Go to Google Account Settings ‚Üí Security</li>
                                        <li>Under "2-Step Verification", click "App passwords"</li>
                                        <li>Generate a new app password for "Mail"</li>
                                    </ul>
                                </li>
                                <li><strong>Update your .env file</strong> with:
                                    <pre style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.25rem; font-size: 0.85rem;">
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-16-digit-app-password
ADMIN_EMAIL=your-email@gmail.com</pre>
                                </li>
                                <li><strong>Restart your server</strong> after updating the .env file</li>
                            </ol>
                        </div>
                    </div>

                    <div id="emailConfigured" style="display: none;">
                        <div class="alert success">
                            <strong>‚úÖ Email alerts configured!</strong>
                            <p>Your email alert system is properly configured and ready to send notifications.</p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button class="btn" onclick="testEmailAlerts()">üß™ Test Alert System</button>
                        <button class="btn success" onclick="testEmailDirectly()">üìß Send Test Email</button>
                        <button class="btn secondary" onclick="showAlertSettings()">‚öôÔ∏è Alert Settings</button>
                        <button class="btn" onclick="checkEmailStatus()">üîÑ Refresh Status</button>
                    </div>

                    <div id="alertTestResults" style="margin-top: 1rem;"></div>
                </div>

                <div class="section-card">
                    <h3 class="section-title">üìä Alert Types</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Alert Type</th>
                                <th>Trigger Condition</th>
                                <th>Status</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>High Error Rate</td>
                                <td>Error rate > 10% in last hour</td>
                                <td><span class="badge success">Active</span></td>
                                <td>Monitors system errors and alerts when error rate exceeds threshold</td>
                            </tr>
                            <tr>
                                <td>High Usage</td>
                                <td>3x higher than 7-day average</td>
                                <td><span class="badge success">Active</span></td>
                                <td>Detects unusual spikes in email analysis requests</td>
                            </tr>
                            <tr>
                                <td>API Failures</td>
                                <td>5+ consecutive AI failures</td>
                                <td><span class="badge success">Active</span></td>
                                <td>Monitors HuggingFace API failures and alerts on consecutive issues</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Alert History Section -->
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="section-title">üìã Alert History</h3>
                        <button class="btn" onclick="loadAlertHistory()">üîÑ Refresh History</button>
                    </div>
                    
                    <div id="alertHistoryContent">
                        <div class="alert info">
                            <strong>üìù Note:</strong> Click "Refresh History" to load recent alert history.
                        </div>
                    </div>
                </div>

                <!-- Alert Settings Modal -->
                <div id="alertSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>‚öôÔ∏è Alert Settings</h3>
                            <button onclick="hideAlertSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        
                        <div id="alertSettingsContent">
                            <div class="alert info">
                                <strong>üìù Loading alert settings...</strong>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="btn secondary" onclick="hideAlertSettings()">Cancel</button>
                            <button class="btn" onclick="saveAlertSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Log Tab -->
            <div id="audit" class="tab-content">
                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 class="section-title">üìã Admin Audit Log</h3>
                        <button class="btn" onclick="loadAuditLog()">üîÑ Refresh Log</button>
                    </div>

                    <div id="auditLogResults">
                        <div class="alert info">
                            <strong>üìù Note:</strong> The audit log tracks all admin actions for security and compliance.
                        </div>
                        <button class="btn" onclick="loadAuditLog()">üìã Load Audit Log</button>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export" class="tab-content">
                <div class="section-card">
                    <h3 class="section-title">üíæ Data Export & Management</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üìä Export Analytics</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Download complete analytics data</p>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="exportData('csv')">üìã CSV</button>
                                <button class="btn secondary" onclick="exportData('json')">üìÑ JSON</button>
                            </div>
                        </div>

                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üóëÔ∏è Data Cleanup</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Remove old data to free up space</p>
                            <button class="btn danger" onclick="clearOldData()">üóëÔ∏è Clear 30+ Days</button>
                        </div>

                        <div style="background: #f9fafb; padding: 1rem; border-radius: 8px;">
                            <h4>üìà Generate Report</h4>
                            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0;">Create detailed PDF report</p>
                            <button class="btn secondary" onclick="generateReport()">üìà PDF Report</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date values for advanced analytics
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Wait for Chart.js to load before initializing dashboard
            function initDashboard() {
                if (typeof Chart === 'undefined') {
                    console.log('Waiting for Chart.js to load...');
                    setTimeout(initDashboard, 500);
                    return;
                }
                console.log('Chart.js loaded, initializing dashboard...');
                loadDashboardData();
            }
            
            initDashboard();
        });

        async function loadDashboardData() {
            try {
                // Load basic stats
                const statsResponse = await fetch('/admin/stats');
                if (statsResponse.ok) {
                    const response = await statsResponse.json();
                    const stats = response.data || response; // Handle both new and old format
                    
                    // Check if data is available
                    if (response.status === 'connection_error' || response.status === 'error') {
                        showErrorMessage(response.message || 'Unable to load statistics');
                        updateStatsWithError();
                    } else {
                        // Update overview stats
                        document.getElementById('total-requests').textContent = stats.total_requests || 0;
                        document.getElementById('success-rate').textContent = (100 - (stats.error_rate || 0)).toFixed(1) + '%';
                        document.getElementById('unique-users').textContent = stats.unique_users || stats.unique_ips || 0;
                        document.getElementById('avg-score').textContent = stats.average_score ? stats.average_score.toFixed(1) : 'N/A';
                        document.getElementById('ai-enhanced').textContent = stats.ai_enhanced_requests || stats.total_requests || 0;
                        document.getElementById('avg-processing-time').textContent = stats.avg_processing_time ? stats.avg_processing_time + 'ms' : '~250ms';
                        
                        // Clear any previous error messages
                        clearErrorMessages();
                    }
                } else {
                    console.error('Failed to load stats');
                    showErrorMessage('Failed to connect to server');
                    updateStatsWithError();
                }

                // Load API usage data
                await loadAPIUsage();

                // Load charts data
                await loadChartsData();

                // Load hourly usage
                await loadHourlyUsage();

                // Load error data
                await loadErrorData();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                updateStatsWithError();
            }
        }

        async function loadAPIUsage() {
            try {
                // Fetch real HuggingFace API usage data from backend
                const response = await fetch('/api/huggingface/usage');
                
                if (response.ok) {
                    const result = await response.json();
                    const apiData = result.data;
                    
                    // Check if there's an error in the API data
                    if (apiData.error) {
                        console.warn('API usage error:', apiData.error);
                        showAPIUsageError(apiData.error);
                        return;
                    }
                    
                    // Update UI with real data
                    document.getElementById('api-requests').textContent = apiData.requests_last_30_days.toLocaleString();
                    document.getElementById('api-tokens').textContent = apiData.estimated_tokens_used.toLocaleString();
                    document.getElementById('api-limit').textContent = apiData.monthly_limit.toLocaleString();
                    document.getElementById('api-remaining').textContent = apiData.estimated_remaining.toLocaleString();
                    
                    const progressBar = document.getElementById('api-progress');
                    const percentage = apiData.usage_percentage;
                    progressBar.style.width = percentage + '%';
                    
                    // Update progress bar color based on usage
                    if (percentage > 80) {
                        progressBar.className = 'progress-fill danger';
                    } else if (percentage > 60) {
                        progressBar.className = 'progress-fill warning';
                    } else {
                        progressBar.className = 'progress-fill';
                    }
                    
                    document.getElementById('api-percentage').textContent = percentage + '% of monthly limit used';
                    
                    // Clear any previous error messages
                    clearAPIUsageError();
                    
                } else {
                    console.error('Failed to load API usage:', response.status, response.statusText);
                    showAPIUsageError('Failed to load API usage data from server');
                }

            } catch (error) {
                console.error('Error loading API usage:', error);
                showAPIUsageError('Network error while loading API usage data');
            }
        }

        function showAPIUsageError(message) {
            // Show error state in API usage section
            document.getElementById('api-requests').textContent = 'Error';
            document.getElementById('api-tokens').textContent = 'Error';
            document.getElementById('api-limit').textContent = 'Error';
            document.getElementById('api-remaining').textContent = 'Error';
            document.getElementById('api-percentage').textContent = message;
            
            const progressBar = document.getElementById('api-progress');
            progressBar.style.width = '0%';
            progressBar.className = 'progress-fill danger';
        }

        function clearAPIUsageError() {
            // This function can be used to clear any error styling if needed
            // For now, it's just a placeholder for future error handling improvements
        }

        async function loadChartsData() {
            try {
                // Load daily stats for chart
                const response = await fetch('/admin/analytics/daily');
                if (response.ok) {
                    const dailyData = await response.json();
                    createDailyChart(dailyData);
                } else {
                    // Create dummy data if endpoint doesn't exist yet
                    const dummyData = generateDummyDailyData();
                    createDailyChart(dummyData);
                }
            } catch (error) {
                console.error('Error loading charts data:', error);
                const dummyData = generateDummyDailyData();
                createDailyChart(dummyData);
            }
        }

        function generateDummyDailyData() {
            const data = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                data.push({
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    total_requests: Math.floor(Math.random() * 50) + 20,
                    ai_enhanced_requests: Math.floor(Math.random() * 30) + 10
                });
            }
            return data;
        }

        // Global variable to track chart instance
        let dailyChart = null;

        function createDailyChart(dailyData) {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet, retrying in 1 second...');
                setTimeout(() => createDailyChart(dailyData), 1000);
                return;
            }
            
            const canvas = document.getElementById('dailyChart');
            if (!canvas) {
                console.error('Daily chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart first
            if (dailyChart) {
                dailyChart.destroy();
                dailyChart = null;
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date),
                    datasets: [{
                        label: 'Total Requests',
                        data: dailyData.map(d => d.total_requests),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'AI Enhanced',
                        data: dailyData.map(d => d.ai_enhanced_requests),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function loadHourlyUsage() {
            try {
                // Fetch real hourly usage data from backend
                const response = await fetch('/admin/analytics/hourly');
                
                if (response.ok) {
                    const hourlyData = await response.json();
                    
                    const hourlyDiv = document.getElementById('hourlyUsage');
                    if (hourlyData.length === 0) {
                        hourlyDiv.innerHTML = '<div class="alert info">No usage data available for today.</div>';
                    } else {
                        hourlyDiv.innerHTML = hourlyData.map(hour => 
                            `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span>${hour.hour}</span>
                                <span><strong>${hour.requests}</strong> requests</span>
                            </div>`
                        ).join('');
                    }
                } else {
                    console.error('Failed to load hourly usage:', response.status);
                    document.getElementById('hourlyUsage').innerHTML = '<div class="alert warning">Failed to load hourly data.</div>';
                }
            } catch (error) {
                console.error('Error loading hourly usage:', error);
                document.getElementById('hourlyUsage').innerHTML = '<div class="alert warning">Error loading hourly data.</div>';
            }
        }

        async function loadErrorData() {
            try {
                // Fetch real error data from backend
                const response = await fetch('/admin/errors');
                
                if (response.ok) {
                    const errors = await response.json();
                    
                    const errorSection = document.getElementById('error-section');
                    const errorList = document.getElementById('error-list');
                    
                    if (errors.length > 0) {
                        errorList.innerHTML = errors.map(error => 
                            `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <div style="font-family: 'Courier New', monospace; font-size: 0.85rem; color: #dc2626;">${error.error}</div>
                                <div style="background: #fee2e2; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${error.count}</div>
                            </div>`
                        ).join('');
                        
                        errorSection.style.display = 'block';
                    } else {
                        // Hide error section if no errors
                        errorSection.style.display = 'none';
                    }
                } else {
                    console.error('Failed to load error data:', response.status);
                    // Hide error section on failure
                    document.getElementById('error-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading error data:', error);
                // Hide error section on error
                document.getElementById('error-section').style.display = 'none';
            }
        }

        function updateStatsWithError() {
            document.getElementById('total-requests').textContent = 'N/A';
            document.getElementById('success-rate').textContent = 'N/A';
            document.getElementById('unique-users').textContent = 'N/A';
            document.getElementById('avg-score').textContent = 'N/A';
            document.getElementById('ai-enhanced').textContent = 'N/A';
            document.getElementById('avg-processing-time').textContent = 'N/A';
        }

        function showErrorMessage(message) {
            // Create or update error banner
            let errorBanner = document.getElementById('error-banner');
            if (!errorBanner) {
                errorBanner = document.createElement('div');
                errorBanner.id = 'error-banner';
                errorBanner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: #fee2e2;
                    color: #dc2626;
                    padding: 12px;
                    text-align: center;
                    border-bottom: 1px solid #fecaca;
                    z-index: 1000;
                    font-weight: 500;
                `;
                document.body.prepend(errorBanner);
            }
            errorBanner.innerHTML = `‚ö†Ô∏è ${message}`;
            errorBanner.style.display = 'block';
        }

        function clearErrorMessages() {
            const errorBanner = document.getElementById('error-banner');
            if (errorBanner) {
                errorBanner.style.display = 'none';
            }
        }

        // Auto-refresh functionality
        let autoRefreshInterval;
        
        function refreshDashboard() {
            loadDashboardData();
        }
        
        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                // Increased interval to 60 seconds to reduce SSL errors
                autoRefreshInterval = setInterval(refreshDashboard, 60000);
            } else {
                clearInterval(autoRefreshInterval);
            }
        }

        // Initialize auto-refresh when checkbox changes
        document.addEventListener('DOMContentLoaded', function() {
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (autoRefreshCheckbox) {
                autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
                // Start auto-refresh by default
                toggleAutoRefresh();
            }
        });

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(navTab => {
                navTab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to selected nav tab
            event.target.classList.add('active');
            
            // Load email status if alerts tab is selected
            if (tabName === 'alerts') {
                checkEmailStatus();
            }
        }

        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/';
            }
        }

        // Advanced Analytics
        async function loadAdvancedAnalytics(event) {
            event.preventDefault();
            
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const ipFilter = document.getElementById('ipFilter').value;
            const scoreMin = document.getElementById('scoreMin').value;
            const scoreMax = document.getElementById('scoreMax').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (ipFilter) params.append('ip_filter', ipFilter);
            if (scoreMin) params.append('min_score', scoreMin);
            if (scoreMax) params.append('max_score', scoreMax);
            
            try {
                const response = await fetch(`/admin/analytics/advanced?${params}`);
                if (response.ok) {
                    const data = await response.json();
                    displayAdvancedAnalytics(data);
                } else {
                    console.error('Advanced analytics failed:', response.status, response.statusText);
                    alert('Failed to load advanced analytics - ' + response.status);
                }
            } catch (error) {
                console.error('Advanced analytics error:', error);
                alert('Error loading analytics: ' + error.message);
            }
        }

        function displayAdvancedAnalytics(data) {
            console.log('Received analytics data:', data);
            
            const resultsDiv = document.getElementById('advancedAnalyticsResults');
            const statsDiv = document.getElementById('filteredStats');
            
            // Ensure data structure exists
            if (!data || !data.filtered_stats) {
                console.error('Invalid analytics data structure:', data);
                alert('Error: Invalid analytics data received');
                return;
            }
            
            // Handle empty state professionally
            if (data.filtered_requests === 0) {
                statsDiv.innerHTML = `
                    <div class="alert info">
                        <h4>üìä No Data Found</h4>
                        <p>${data.message || 'No data matches your current filters.'}</p>
                        ${data.suggestions ? `
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${data.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        ` : ''}
                        <p><strong>Suggestions:</strong></p>
                        <ul>
                            <li>Try a broader date range</li>
                            <li>Remove or adjust filters</li>
                            <li>Check if data exists for this time period</li>
                        </ul>
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }
            
            console.log('Filtered stats:', data.filtered_stats);
            
            // Display filtered stats
            statsDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.filtered_stats.total_requests || 0}</div>
                        <div class="stat-label">Filtered Requests</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${data.filtered_stats.avg_score || 0}</div>
                        <div class="stat-label">Average Score</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${data.filtered_stats.unique_ips || 0}</div>
                        <div class="stat-label">Unique IPs</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number">${data.filtered_stats.error_count || 0}</div>
                        <div class="stat-label">Errors</div>
                    </div>
                </div>
            `;
            
            // Show chart if distribution data exists
            if (data.score_distribution && data.score_distribution.length > 0) {
                console.log('Creating score distribution chart with:', data.score_distribution);
                createScoreDistributionChart(data.score_distribution);
            } else {
                console.log('No score distribution data available');
                // Show empty chart state
                const chartContainer = document.getElementById('scoreDistributionChart').parentElement;
                chartContainer.innerHTML = `
                    <div class="alert info" style="text-align: center; padding: 40px;">
                        <h4>üìà No Chart Data</h4>
                        <p>Not enough data to generate score distribution chart.</p>
                    </div>
                `;
            }
            
            resultsDiv.style.display = 'block';
        }

        // Global variable to track score distribution chart
        let scoreDistributionChart = null;

        function createScoreDistributionChart(distributionData) {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded yet, retrying in 1 second...');
                setTimeout(() => createScoreDistributionChart(distributionData), 1000);
                return;
            }
            
            const canvas = document.getElementById('scoreDistributionChart');
            if (!canvas) {
                console.error('Score distribution chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart first
            if (scoreDistributionChart) {
                scoreDistributionChart.destroy();
                scoreDistributionChart = null;
            }
            
            scoreDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: distributionData.map(d => d.range),
                    datasets: [{
                        data: distributionData.map(d => d.count),
                        backgroundColor: [
                            '#10b981',  // Excellent - Green
                            '#3b82f6',  // Good - Blue
                            '#f59e0b',  // Fair - Yellow
                            '#ef4444'   // Poor - Red
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Score Distribution'
                        }
                    }
                }
            });
        }        // Admin Users Management
        function showCreateUserForm() {
            document.getElementById('createUserForm').style.display = 'block';
        }

        function hideCreateUserForm() {
            document.getElementById('createUserForm').style.display = 'none';
        }

        async function createAdminUser(event) {
            event.preventDefault();
            
            const userData = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                email: document.getElementById('newEmail').value,
                role: document.getElementById('newRole').value
            };
            
            try {
                const response = await fetch('/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    alert('Admin user created successfully!');
                    hideCreateUserForm();
                    loadAdminUsers();
                } else {
                    const error = await response.json();
                    alert('Failed to create user: ' + error.detail);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        }

        async function loadAdminUsers() {
            try {
                const response = await fetch('/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    displayAdminUsers(data.admin_users);
                } else {
                    alert('Failed to load admin users');
                }
            } catch (error) {
                alert('Error loading users: ' + error.message);
            }
        }

        function displayAdminUsers(users) {
            const listDiv = document.getElementById('adminUsersList');
            
            if (users.length === 0) {
                listDiv.innerHTML = '<div class="alert info">No admin users found.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email || 'N/A'}</td>
                                <td><span class="badge ${user.role === 'admin' ? 'success' : 'warning'}">${user.role}</span></td>
                                <td>${user.created_at}</td>
                                <td>${user.last_login || 'Never'}</td>
                                <td><span class="badge ${user.is_active ? 'success' : 'danger'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            listDiv.innerHTML = tableHTML;
        }

        // Email Alerts
        async function testEmailAlerts() {
            try {
                const response = await fetch('/admin/alerts/test', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('alertTestResults').innerHTML = `
                        <div class="alert success">
                            <strong>‚úÖ Alert Test Complete:</strong> ${result.message}
                        </div>
                    `;
                } else {
                    document.getElementById('alertTestResults').innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Alert Test Failed:</strong> Check your email configuration.
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('alertTestResults').innerHTML = `
                    <div class="alert warning">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function testEmailDirectly() {
            try {
                const response = await fetch('/admin/alerts/test-email', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('alertTestResults').innerHTML = `
                            <div class="alert success">
                                <strong>‚úÖ Test Email Sent Successfully!</strong><br>
                                <small>${result.message}</small><br>
                                <small>Recipient: ${result.recipient}</small>
                            </div>
                        `;
                    } else {
                        document.getElementById('alertTestResults').innerHTML = `
                            <div class="alert warning">
                                <strong>‚ö†Ô∏è Test Email Failed:</strong> ${result.message}
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('alertTestResults').innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Test Email Failed:</strong> Server error
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('alertTestResults').innerHTML = `
                    <div class="alert warning">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function checkEmailStatus() {
            try {
                const response = await fetch('/admin/alerts/status');
                if (response.ok) {
                    const status = await response.json();
                    displayEmailStatus(status);
                } else {
                    displayEmailStatus({ configured: false, error: 'Failed to check email status' });
                }
            } catch (error) {
                displayEmailStatus({ configured: false, error: error.message });
            }
        }

        function displayEmailStatus(status) {
            const statusDiv = document.getElementById('emailStatus');
            const setupDiv = document.getElementById('emailSetupInstructions');
            const configuredDiv = document.getElementById('emailConfigured');
            
            if (status.configured) {
                statusDiv.innerHTML = '<strong>‚úÖ Email alerts configured!</strong>';
                statusDiv.className = 'alert success';
                setupDiv.style.display = 'none';
                configuredDiv.style.display = 'block';
            } else {
                statusDiv.innerHTML = '<strong>‚ö†Ô∏è Email alerts not configured</strong>';
                statusDiv.className = 'alert warning';
                setupDiv.style.display = 'block';
                configuredDiv.style.display = 'none';
                
                if (status.issues && status.issues.length > 0) {
                    statusDiv.innerHTML += `<br><small>Issues: ${status.issues.join(', ')}</small>`;
                }
            }
        }

        function showAlertSettings() {
            document.getElementById('alertSettingsModal').style.display = 'block';
            loadCurrentAlertConfig();
        }

        function hideAlertSettings() {
            document.getElementById('alertSettingsModal').style.display = 'none';
        }

        async function loadCurrentAlertConfig() {
            try {
                // Load both email status and alert settings
                const [statusResponse, settingsResponse] = await Promise.all([
                    fetch('/admin/alerts/status'),
                    fetch('/admin/alerts/settings')
                ]);
                
                const status = statusResponse.ok ? await statusResponse.json() : null;
                const settings = settingsResponse.ok ? await settingsResponse.json() : null;
                
                const configDiv = document.getElementById('alertSettingsContent');
                
                if (status && settings) {
                    configDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <!-- Email Configuration -->
                            <div>
                                <h4>üìß Email Configuration</h4>
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <p><strong>SMTP Server:</strong> ${status.smtp_server}:${status.smtp_port}</p>
                                    <p><strong>Username:</strong> ${status.smtp_username}</p>
                                    <p><strong>Password:</strong> ${status.smtp_password_set ? '‚úÖ Configured' : '‚ùå Not set'}</p>
                                    <p><strong>Admin Email:</strong> ${status.admin_email || 'Not configured'}</p>
                                </div>
                                
                                <div class="alert ${status.configured ? 'success' : 'warning'}">
                                    <strong>${status.configured ? '‚úÖ Email alerts configured!' : '‚ö†Ô∏è Email alerts not configured'}</strong>
                                    ${status.issues && status.issues.length > 0 ? `<br><small>Issues: ${status.issues.join(', ')}</small>` : ''}
                                </div>
                            </div>
                            
                            <!-- Alert Settings -->
                            <div>
                                <h4>üö® Alert Thresholds</h4>
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                    <div style="margin-bottom: 1rem;">
                                        <label><strong>Error Rate Alert:</strong></label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="errorRateEnabled" ${settings.settings.alerts_enabled.error_rate ? 'checked' : ''}>
                                            <span>Trigger when error rate ></span>
                                            <input type="number" id="errorRateThreshold" value="${settings.settings.error_rate_threshold}" min="1" max="100" step="0.1" style="width: 80px;">
                                            <span>% (min ${settings.settings.error_rate_min_requests} requests)</span>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem;">
                                        <label><strong>High Usage Alert:</strong></label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="highUsageEnabled" ${settings.settings.alerts_enabled.high_usage ? 'checked' : ''}>
                                            <span>Trigger when usage ></span>
                                            <input type="number" id="highUsageMultiplier" value="${settings.settings.high_usage_multiplier}" min="1" max="10" step="0.1" style="width: 80px;">
                                            <span>x average (min ${settings.settings.high_usage_min_requests} requests)</span>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem;">
                                        <label><strong>API Failure Alert:</strong></label>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="checkbox" id="apiFailureEnabled" ${settings.settings.alerts_enabled.api_failure ? 'checked' : ''}>
                                            <span>Trigger after</span>
                                            <input type="number" id="apiFailureThreshold" value="${settings.settings.api_failure_threshold}" min="1" max="20" style="width: 80px;">
                                            <span>consecutive failures (${settings.settings.api_failure_window} min window)</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <h4>‚è∞ Quiet Hours</h4>
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="quietHoursEnabled" ${settings.settings.quiet_hours.enabled ? 'checked' : ''}>
                                        <span>Enable quiet hours</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span>From:</span>
                                        <input type="time" id="quietHoursStart" value="${settings.settings.quiet_hours.start}" style="width: 100px;">
                                        <span>To:</span>
                                        <input type="time" id="quietHoursEnd" value="${settings.settings.quiet_hours.end}" style="width: 100px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <h4>üìß Email Recipients</h4>
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                                <p><strong>Current Recipients:</strong></p>
                                <ul>
                                    ${settings.settings.email_recipients.map(email => `<li>${email}</li>`).join('')}
                                </ul>
                                <p style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                                    <em>Note: Email recipients are configured in your .env file (ADMIN_EMAIL)</em>
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    configDiv.innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Failed to load settings</strong><br>
                            <small>Error loading alert configuration</small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('alertSettingsContent').innerHTML = `
                    <div class="alert warning">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function saveAlertSettings() {
            try {
                // Collect all form values
                const settings = {
                    alerts_enabled: {
                        error_rate: document.getElementById('errorRateEnabled')?.checked || false,
                        high_usage: document.getElementById('highUsageEnabled')?.checked || false,
                        api_failure: document.getElementById('apiFailureEnabled')?.checked || false
                    },
                    error_rate_threshold: parseFloat(document.getElementById('errorRateThreshold')?.value || 10.0),
                    high_usage_multiplier: parseFloat(document.getElementById('highUsageMultiplier')?.value || 3.0),
                    api_failure_threshold: parseInt(document.getElementById('apiFailureThreshold')?.value || 5),
                    quiet_hours: {
                        enabled: document.getElementById('quietHoursEnabled')?.checked || false,
                        start: document.getElementById('quietHoursStart')?.value || '22:00',
                        end: document.getElementById('quietHoursEnd')?.value || '08:00'
                    }
                };

                const response = await fetch('/admin/alerts/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('‚úÖ Alert settings saved successfully!\n\n' + (result.note || ''));
                    hideAlertSettings();
                } else {
                    const error = await response.json();
                    alert('‚ùå Failed to save alert settings: ' + (error.detail || error.message || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error saving alert settings: ' + error.message);
            }
        }

        // Audit Log
        async function loadAuditLog() {
            try {
                const response = await fetch('/admin/audit-log');
                if (response.ok) {
                    const data = await response.json();
                    displayAuditLog(data.audit_logs);
                } else {
                    alert('Failed to load audit log');
                }
            } catch (error) {
                alert('Error loading audit log: ' + error.message);
            }
        }

        function displayAuditLog(logs) {
            const resultsDiv = document.getElementById('auditLogResults');
            
            if (logs.length === 0) {
                resultsDiv.innerHTML = '<div class="alert info">No audit log entries found.</div>';
                return;
            }
            
            const tableHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${log.timestamp}</td>
                                <td>${log.admin_username || log.username || 'Unknown'}</td>
                                <td><span class="badge success">${log.action}</span></td>
                                <td>${log.details || 'N/A'}</td>
                                <td>${log.ip_address || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            resultsDiv.innerHTML = tableHTML;
        }

        async function loadAlertHistory() {
            try {
                const response = await fetch('/admin/alerts/history');
                if (response.ok) {
                    const data = await response.json();
                    const historyDiv = document.getElementById('alertHistoryContent');
                    
                    if (data.alerts && data.alerts.length > 0) {
                        const tableHTML = `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Alert Type</th>
                                        <th>Details</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.alerts.map(alert => `
                                        <tr>
                                            <td>${alert.timestamp}</td>
                                            <td><span class="badge ${alert.type === 'error_rate' ? 'danger' : alert.type === 'high_usage' ? 'warning' : 'info'}">${alert.type.replace('_', ' ').toUpperCase()}</span></td>
                                            <td>${alert.details}</td>
                                            <td><span class="badge success">Sent</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        historyDiv.innerHTML = tableHTML;
                    } else {
                        historyDiv.innerHTML = `
                            <div class="alert success">
                                <strong>‚úÖ No Alerts Sent</strong><br>
                                <small>${data.message || 'No alerts have been triggered recently. This is good news - it means your system is running smoothly!'}</small>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('alertHistoryContent').innerHTML = `
                        <div class="alert warning">
                            <strong>‚ö†Ô∏è Failed to load alert history</strong><br>
                            <small>Server error occurred while loading history</small>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('alertHistoryContent').innerHTML = `
                    <div class="alert warning">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Export functions
        async function exportData(format) {
            try {
                const response = await fetch(`/admin/export?format=${format}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `inboxqualify_data_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Export failed. Please try again.');
                }
            } catch (error) {
                alert('Export failed: ' + error.message);
            }
        }

        async function clearOldData() {
            if (confirm('This will permanently delete data older than 30 days. Are you sure?')) {
                try {
                    const response = await fetch('/admin/cleanup', {
                        method: 'POST'
                    });
                    if (response.ok) {
                        const result = await response.json();
                        alert(`‚úÖ Success: ${result.message}`);
                    } else {
                        alert('Failed to clear old data.');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function runAlertChecks() {
            try {
                const response = await fetch('/admin/alerts/test', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('‚úÖ Alert checks completed! Check your email and logs.');
                } else {
                    alert('‚ö†Ô∏è Alert checks failed. Check configuration.');
                }
            } catch (error) {
                alert('‚ùå Error running alert checks: ' + error.message);
            }
        }

        function generateReport() {
            // Show loading state
            const originalText = event.target.textContent;
            event.target.textContent = 'üìà Generating...';
            event.target.disabled = true;
            
            fetch('/admin/reports/generate-pdf', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create a new window with the report
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(data.html_content);
                    reportWindow.document.close();
                    
                    alert('‚úÖ PDF report generated successfully!\n\n' + (data.note || ''));
                } else {
                    alert('‚ùå Failed to generate report: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå Error generating report: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                event.target.textContent = originalText;
                event.target.disabled = false;
            });
        }
    </script>
</body>
</html>
